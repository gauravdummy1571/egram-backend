name: Build and Deploy to Render

# ============================================================================
# Trigger Configuration
# ============================================================================
# This workflow runs on:
# 1. Push events to the main branch
# 2. Manual trigger via GitHub Actions UI (workflow_dispatch)
on:
  push:
    branches:
      - main
  workflow_dispatch:

# ============================================================================
# Environment Variables
# ============================================================================
# CHANGE IMAGE_NAME to customize the Docker image repository name
# Format: dockerhub_username/image_name
# This is used to build: dockerhub_username/egram-service:latest
env:
  REGISTRY: docker.io
  IMAGE_NAME: egram-service

# ============================================================================
# Jobs Definition
# ============================================================================
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # Permissions required for Docker image push and OIDC token generation
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      # ========================================================================
      # Step 1: Checkout Repository
      # ========================================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================================================
      # Step 2: Set up Java 17 and Maven
      # ========================================================================
      # Java 17 is used for compatibility; the app targets Java 21/22 but
      # Maven 3.9.6 with Java 17 can build Java 21+ projects
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # ========================================================================
      # Step 3: Build Spring Boot Application
      # ========================================================================
      # Runs Maven clean package, skipping tests for faster CI/CD pipeline
      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      # ========================================================================
      # Step 4: Set up Docker Buildx
      # ========================================================================
      # Buildx enables advanced features like multi-platform builds and caching
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ========================================================================
      # Step 5: Log in to Docker Hub
      # ========================================================================
      # Uses secrets DOCKERHUB_USERNAME and DOCKERHUB_TOKEN for authentication
      #
      # ⚠️  REQUIRED GITHUB SECRETS (set in Settings → Secrets and Variables):
      #     - DOCKERHUB_USERNAME: Your Docker Hub username
      #     - DOCKERHUB_TOKEN: Docker Hub access token (create at hub.docker.com/settings/security)
      #
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ========================================================================
      # Step 6: Extract metadata for Docker image
      # ========================================================================
      # Generates Docker image tags and labels
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest

      # ========================================================================
      # Step 7: Build and Push Docker Image
      # ========================================================================
      # Builds the Docker image using the Dockerfile in the repo root
      # Pushes to Docker Hub with tags specified in metadata step
      #
      # This step:
      # - Uses the Dockerfile at ./Dockerfile
      # - Tags image as: docker.io/{username}/{IMAGE_NAME}:latest
      # - Pushes to Docker Hub after successful build
      # - Uploads SBOM (Software Bill of Materials) for security scanning
      #
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          sbom: true

      # ========================================================================
      # Step 8: Trigger Render Deployment
      # ========================================================================
      # After Docker image is successfully pushed, triggers a deployment on Render
      # via webhook
      #
      # ⚠️  REQUIRED GITHUB SECRET:
      #     - RENDER_DEPLOY_HOOK_URL: Your Render deployment webhook URL
      #       Get this from: Render Dashboard → Web Service → Environment → Deploy Hook
      #
      # The curl command:
      # - -sSf: Silent mode, show errors, fail on HTTP errors
      # - -X POST: Send POST request
      # - Waits for Render to receive and queue the deployment
      #
      - name: Trigger Render deploy
        if: success()
        run: |
          curl -sSf -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
          echo "✅ Render deployment triggered successfully"
        continue-on-error: true
        timeout-minutes: 2

      # ========================================================================
      # Step 9: Build Status Notification (Optional)
      # ========================================================================
      # Reports job status; useful for debugging failed workflows
      - name: Job Status Summary
        if: always()
        run: |
          echo "## Workflow Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: \`${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

